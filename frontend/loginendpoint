async function hashKey(key) {
  const encoder = new TextEncoder();
  const data = encoder.encode(key);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  return [...new Uint8Array(hashBuffer)]
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

export default {
  async fetch(request, env) {

    if (request.method === "POST") {
      const body = await request.json();

      if (body.type === "LOGIN") {
        const hashed = await hashKey(body.key);

        const { results } = await env.DB.prepare(
          "SELECT * FROM users WHERE username = ? AND key_hash = ?"
        )
        .bind(body.username, hashed)
        .all();

        if (results.length > 0) {
          return new Response(JSON.stringify({
            success: true,
            role: results[0].role
          }));
        }

        return new Response(JSON.stringify({ success: false }), { status: 401 });
      }
    }

    return new Response("Invalid request", { status: 400 });
  }
}
